# **Taxonomy Builder — Phase‑Ranked Blueprint (v1)**

> Goal: implement **all files** in a reliable order, with a **smoke test at the end of every phase**. Run everything from **Build/src** unless noted. Output target: **Build/src/data/taxonomy.json**.

## **Phase 0 — Bootstrap & Scaffolding**

**Why:** establish package layout, deps, and an output folder so later phases don’t churn.

**Files to touch**

* tools/taxonomy\_builder/\_\_init\_\_.py**: empty sentinel.**
* tools/taxonomy\_builder/requirements.txt**:**
  * beautifulsoup4==4.12.3
  * jsonschema==4.21.1
  * requests==2.32.3
  * (optional) **playwright** later
* **tools/taxonomy\_builder/logging\_setup.py**: JSON logger config (basic, INFO default).
* **tools/taxonomy\_builder/config.py**: central config (env vars for profile, paths; output dir = **./data**).
* **tools/taxonomy\_builder/data/**: add fixture **clutch\_directory.html** (copy from screenshot page source later) & **taxonomy.sample.json** (empty **{}** placeholder now).
* Create **./data/** (top‑level under **Build/src/**) — holds **outputs**.

**Smoke test**

* pip install -r tools/taxonomy\_builder/requirements.txt
* python -c "import tools.taxonomy\_builder as x; print('ok')"
* Expect: prints **ok**.

## **Phase 1 — Entrypoints & CLI**

**Why:** a stable invocation surface before internal plumbing.

**Files to implement**

* tools/taxonomy\_builder/\_\_main\_\_.py:
  * Parse **--self-check** (delegates to entrypoint banner).
  * Else delegate to CLI **main()**.
* tools/taxonomy\_builder/cli.py**:**
  * Subcommand **build** with flags:
    * **--html <file>** (fixture path)
    * --out <file>** (default **./data/taxonomy.json**)**
    * --profile <dev|ci|prod>** (default **dev**)**
  * **Call **runtime\_delivery.runner.run\_build(...)**.**
* tools/taxonomy\_builder/runtime\_delivery/entrypoint.py**:**
  * **print\_config\_banner()** summarizing versions and resolved config.
* tools/taxonomy\_builder/runtime\_delivery/profiles.py**:**
  * Map **dev|ci|prod** → knobs (e.g., robots off/on, rate limits).

**Smoke test**

* python -m tools.taxonomy\_builder --self-check** → banner printed, exit 0.**
* python -m tools.taxonomy\_builder build --help** → shows flags.**

---

## **Phase 2 — Platform & Ops (minimal)**

**Why:** guardrails early: governance, security, health, metrics shells.

**Files to implement**

* platform\_ops/governance.py**:**
  * **robots\_policy(profile)->bool** (dev=false, prod=true now).
  * **allow\_domain(url)->bool** (always true for fixture).
* platform\_ops/security.py**:**
  * **redact(value:str)->str** (mask emails/tokens for logs).
* platform\_ops/observability.py**:**
  * Counters dict (**inc(name, \*\*labels)**), timers (**time\_block(name)** context manager), **flush\_metrics()** → prints JSON.
* platform\_ops/health.py**:**
  * readiness()->dict** (return static OK), **liveness()->dict** (OK).**

**Smoke test**

* python - <<'PY' from tools.taxonomy\_builder.platform\_ops import governance, security, observability, health print(governance.robots\_policy('dev')) print(security.redact('token\_abc123')) with observability.time\_block('demo'): pass observability.inc('runs\_started') observability.flush\_metrics() print(health.readiness(), health.liveness()) PY
* Expect: True/False per policy, redacted token, metrics JSON printed, health OK.

---

## **Phase 3 — Fetch Layer (offline‑first)**

**Why:** standard interface for content retrieval, even for fixture files.

**Files to implement**

* pipeline\_core/fetch/backoff.py**:**
  * should\_retry(status:int)->bool** (429/5xx), **next\_sleep(retry:int)->float** (exp backoff with jitter).**
* pipeline\_core/fetch/rate\_limit.py**:**
  * Simple token bucket (global), **acquire()** non‑blocking + sleep.
* pipeline\_core/fetch/cache.py**:**
  * No‑op stubs returning **(None, None)** for etag/lastmod (wire later).
* pipeline\_core/fetch/client.py**:**
  * get\_text(url, \*, use\_fixture=False, fixture\_path=None)->(status, text)**.**
  * **If **use\_fixture=True**, open file and return **(200, <html>)**.**
  * Else real HTTP with backoff/rate limit (kept but **disabled** in dev profile default).
* **pipeline\_core/fetch/headless.py**: placeholder class raising **NotImplementedError** (future feature flag).

**Smoke test**

* python - <<'PY' from tools.taxonomy\_builder.pipeline\_core.fetch.client import get\_text s, t = get\_text('file://fixture', use\_fixture=True, fixture\_path='tools/taxonomy\_builder/data/clutch\_directory.html') print(s, len(t)>100) PY
* Expect: **200 True**.

---

## **Phase 4 — Parse (directory page → raw items)**

**Why:** convert HTML to raw category/subcategory/all‑in links.

**Files to implement**

* pipeline\_core/parse/selectors.py**:**
  * Define CSS selectors for: category blocks, subcategory labels, “All in …” anchors.
  * Provide primary + fallbacks list.
* pipeline\_core/parse/directory\_parser.py**:**
  * parse\_directory(html:str)->list[dict]** returning items like **{type:'category'|'subcategory'|'all\_in', name:'SEO', href:'/seo', parent:'Advertising & Marketing'}**.**

**Smoke test**

* python - <<'PY' from pathlib import Path from tools.taxonomy\_builder.pipeline\_core.parse.directory\_parser import parse\_directory html = Path('tools/taxonomy\_builder/data/clutch\_directory.html').read\_text() items = parse\_directory(html) print('items:', len(items), 'first:', items[0] if items else None) PY
* Expect: non‑zero items; sample structure printed.

---

## **Phase 5 — Normalize (text/urls/types/lineage)**

**Why:** canonicalize names and URLs, tag items, and attach ancestry.

**Files to implement**

* pipeline\_core/normalize/text.py**: **clean(s)**, **slugify(s)** (lowercase, dashes, ascii safe).**
* pipeline\_core/normalize/urls.py**: **canonicalize(base, href)** → absolute, strip tracking.**
* pipeline\_core/normalize/types.py**: small enum helpers; **is\_all\_in(name, href)**.**
* pipeline\_core/normalize/lineage.py**:**
  * attach\_lineage(items)->list[dict]** linking children to parents and computing stable IDs **{id, parent\_id, type, name, slug, url}**.**

**Smoke test**

* python - <<'PY' from pathlib import Path from tools.taxonomy\_builder.pipeline\_core.parse.directory\_parser import parse\_directory from tools.taxonomy\_builder.pipeline\_core.normalize.lineage import attach\_lineage from tools.taxonomy\_builder.pipeline\_core.normalize.text import slugify html = Path('tools/taxonomy\_builder/data/clutch\_directory.html').read\_text() raw = parse\_directory(html) norm = attach\_lineage(raw) print('norm:', len(norm), 'slug example:', slugify('Social Media Marketing')) PY
* Expect: normalized count and a slug like **social-media-marketing**.

---

## **Phase 6 — Assemble & Validate**

**Why:** enforce contract and create indexes.

**Files to implement**

* pipeline\_core/assemble\_validate/schema\_loader.py**:**
  * **Load **schema/taxonomy.schema.json** (draft‑07).**
* pipeline\_core/assemble\_validate/validate.py**:**
  * validate\_taxonomy(doc)** raising on failure.**
* pipeline\_core/assemble\_validate/dedupe.py**:**
  * **Drop dupes by **(type, slug, parent\_slug)**.**
* pipeline\_core/assemble\_validate/index.py**:**
  * Build **by\_category**, **by\_slug** helper maps.
* schema/taxonomy.schema.json**:**
  * **Define **version**, **source**, **collected\_at**, **items:[{id,type,name,slug,url,parent\_id?}]**.**

**Smoke test**

* Tiny driver:
  * python - <<'PY' from pathlib import Path from tools.taxonomy\_builder.pipeline\_core.parse.directory\_parser import parse\_directory from tools.taxonomy\_builder.pipeline\_core.normalize.lineage import attach\_lineage from tools.taxonomy\_builder.pipeline\_core.assemble\_validate.validate import validate\_taxonomy html = Path('tools/taxonomy\_builder/data/clutch\_directory.html').read\_text() items = attach\_lineage(parse\_directory(html)) doc = {'version':'0.1.0','source':'fixture','collected\_at':'2025-01-01T00:00:00Z','items':items} validate\_taxonomy(doc) print('validated') PY
* Expect: **validated** printed.

---

## **Phase 7 — Output Writers**

**Why:** persist results and optional helper files.

**Files to implement**

* pipeline\_core/output/provenance.py**: stamp **source**, **run\_id**, **parser\_version**.**
* pipeline\_core/output/writer.py**: atomic write to **./data/taxonomy.json**.**
* **pipeline\_core/output/choices.py**: write **choices.json** (top‑level categories + sub lists).
* pipeline\_core/output/deadletter.py**: append JSONL for failures.**

**Smoke test**

* python - <<'PY' from pathlib import Path from tools.taxonomy\_builder.pipeline\_core.parse.directory\_parser import parse\_directory from tools.taxonomy\_builder.pipeline\_core.normalize.lineage import attach\_lineage from tools.taxonomy\_builder.pipeline\_core.output.writer import write\_json items = attach\_lineage(parse\_directory(Path('tools/taxonomy\_builder/data/clutch\_directory.html').read\_text())) write\_json({'version':'0.1.0','source':'fixture','collected\_at':'2025-01-01T00:00:00Z','items':items}, 'data/taxonomy.json') print('wrote') PY
* **Expect: **data/taxonomy.json** exists.**

---

## **Phase 8 — Runner Orchestration**

**Why:** glue everything into one executable path for the CLI.

**Files to implement**

* runtime\_delivery/runner.py**:**
  * Resolve profile; set policies & metrics.
  * Fetch HTML (fixture path from **--html**).
  * Parse → Normalize → Dedupe → Assemble **doc** → Validate.
  * Add provenance → Write outputs → Flush metrics.
  * Return exit code 0/2 accordingly.

**Smoke test**

* python -m tools.taxonomy\_builder build --html tools/taxonomy\_builder/data/clutch\_directory.html --out ./data/taxonomy.json
* Expect: exit 0; file written; metrics printed.

---

## **Phase 9 — Tests**

**Why:** lock behavior with fixtures before live crawling exists.

**Files to implement**

* tests/tools/taxonomy\_builder/unit/test\_text.py** (slugify, clean)**
* tests/tools/taxonomy\_builder/unit/test\_urls.py** (canonicalize)**
* tests/tools/taxonomy\_builder/unit/test\_backoff.py
* tests/tools/taxonomy\_builder/parser/test\_directory\_parser.py** (counts, presence of specific labels)**
* tests/tools/taxonomy\_builder/integration/test\_runner\_fixture.py** (end‑to‑end with fixture)**
* tests/tools/taxonomy\_builder/smoke/test\_smoke\_fixture.py** (file exists, non‑empty items)**

**Smoke test**

* pytest -q tests/tools/taxonomy\_builder

---

## **Phase 10 — DX & Makefile polish**

**Why:** one‑liners for common flows; consistent outputs.

**Files to implement**

* **Makefile** targets:
  * init**, **smoke**, **test**, **build-fixture**, **clean**.**

**Smoke test**

* **make smoke** → should build taxonomy from fixture and validate.

---

## **Phase 11 — (Optional) Live Fetch Track**

**Why:** prepare for real website runs later without breaking fixture flow.

**Files to extend**

* **Enable **client.get\_text()** network path behind **profile == 'prod'**.**
* Add **governance.robots\_fetch(url)** if you choose to respect robots in prod.
* **Add **headless.fetch\_rendered(url)** behind **--use-headless**.**

**Smoke test**

* Keep using fixture in CI. Add a manual **prod** runbook when you’re ready.

---

## **Run order recap (single command once Phases 0–8 complete)**

```
cd Build/src
python -m tools.taxonomy_builder build \
  --profile dev \
  --html tools/taxonomy_builder/data/clutch_directory.html \
  --out ./data/taxonomy.json
```

**Success criteria:**

* **data/taxonomy.json** exists, passes schema validation, contains categories, subcategories, and “All in …” links with lineage and slugs.
* Metrics printed; exit code 0.
